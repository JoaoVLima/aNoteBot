#!/usr/bin/env python3

import sqlite3
from datetime import datetime
import typer
from rich.console import Console
from rich.table import Table

app = typer.Typer(name="aNoteBot")
console = Console()
DB = "tasks.db"

def init_db():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS tasks (
                    id INTEGER PRIMARY KEY,
                    name TEXT,
                    status TEXT,
                    created_at TEXT
                )''')
    conn.commit()
    conn.close()

@app.command(name="add", short_help="Adicionar uma task")
def add(name: str):
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute("INSERT INTO tasks (name, status, created_at) VALUES (?, ?, ?)",
              (name, "pendente", datetime.now().isoformat()))
    conn.commit()
    conn.close()
    console.print(f"Atividade '{name}' adicionada!", style="green")

@app.command(name="list", short_help="Lista todas as atividades.")
def list():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute("SELECT id, name, status, created_at FROM tasks")
    rows = c.fetchall()
    conn.close()

    table = Table(title="Atividades")
    table.add_column("ID")
    table.add_column("Nome")
    table.add_column("Status")
    table.add_column("Criada em")

    for r in rows:
        table.add_row(str(r[0]), r[1], r[2], r[3][:10])
    console.print(table)

@app.command(name="report", short_help="Gera um relatório simples do dia.")
def report():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM tasks WHERE status='pendente'")
    pending = c.fetchone()[0]
    c.execute("SELECT COUNT(*) FROM tasks WHERE status='concluída'")
    done = c.fetchone()[0]
    conn.close()
    console.print(f"Relatório de hoje:")
    console.print(f"Pendentes: {pending}\n• Concluídas: {done}")

if __name__ == "__main__":
    init_db()
    app()